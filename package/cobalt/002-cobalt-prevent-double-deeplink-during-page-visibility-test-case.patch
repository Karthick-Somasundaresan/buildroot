From 6ba4656cfeafe09233b9e6646a334bc67ea0e5c5 Mon Sep 17 00:00:00 2001
From: modeveci <o.deveci@metrological.com>
Date: Thu, 4 Mar 2021 14:08:28 +0100
Subject: [PATCH] [deeplink]: Prevent double deeplink during Page visibility
 test case

---
 src/third_party/starboard/wpe/shared/application_wpe.cc | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/third_party/starboard/wpe/shared/application_wpe.cc b/src/third_party/starboard/wpe/shared/application_wpe.cc
index d9dfa3306..8a5726918 100644
--- a/src/third_party/starboard/wpe/shared/application_wpe.cc
+++ b/src/third_party/starboard/wpe/shared/application_wpe.cc
@@ -102,8 +102,12 @@ void Application::NavigateTo(const char* url) {
 
 void Application::DeepLink(const char* link_data) {
   if (link_data != nullptr) {
-      deep_link_ = std::string(link_data);
-    ::starboard::shared::starboard::Application::Link(link_data);
+    ::starboard::shared::starboard::Application::State state = ::starboard::shared::starboard::Application::state();
+    // Only fire the link event when it is started, other states will fire during suspended -> resume transition.
+    if (state == ::starboard::shared::starboard::Application::State::kStateStarted) {
+        ::starboard::shared::starboard::Application::Link(link_data);
+    }
+    deep_link_ = std::string(link_data);
   }
 }
